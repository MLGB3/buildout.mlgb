[buildout]
extensions =
    buildout.bootstrap
    mr.developer

# prevents lockouts (?) when doing paralell checkouts
# switched to git repo now and no longer an issue
# mr.developer-threads = 4

extends =
    buildouts/apache.cfg
    buildouts/solr.cfg
    versions.cfg

parts =
    static
    django
    django-settings
    setup-py
    django-solr-config
    omelette
    solr-download
    solr
    copy-mysql-jars
    solr-config
    books-config
    catalogues-config
    jetty-config
    catalogues-data-config
    books-data-config
    apache
    mod-wsgi-install
    mod-wsgi-config
    apache-wsgi-config
    apache-httpd-config
    jobs
    docs
    index
    rename-hardcoded-paths
    cron-script
    cron-setup

eggs =
    ${buildout:auto-checkout}
    Django
    MySQL-python
    pillow
    simplejson

auto-checkout =
    mysite
    static
    solr
    cron

dollar = $

sources-dir = 
    ${buildout:directory}

versions = versions
show-picked-versions = true

serveraddress =  
servername = 
serverport = 80
buildout-user = ${env:USER}

[static]
recipe = z3c.recipe.mkdir
paths = static/

[hosts]
hostname = localhost

[django]
recipe = djangorecipe
settings = settings
eggs = ${buildout:eggs}
project = mysite.apache
extra-paths =
    ${buildout:directory}/mysite/apache
wsgi = true

[django-settings]
recipe = collective.recipe.template
input = conf/settings.py
output = ${buildout:directory}/mysite/apache/settings.py

[setup-py]
recipe = collective.recipe.template
input = conf/setup.py
output = ${buildout:directory}/mysite/setup.py

[django-solr-config]
recipe = collective.recipe.template
input = conf/config.py
output = ${buildout:directory}/mysite/mlgb/config.py

[omelette]
recipe = collective.recipe.omelette
eggs = ${buildout:eggs}

[sources]
mysite = svn https://damssupport.bodleian.ox.ac.uk/svn/mlgb3/trunk/mysite/

# media and templates dir 
static= svn https://damssupport.bodleian.ox.ac.uk/svn/mlgb3/trunk/www/mlgb/ egg=false

# solr conf
solr = svn https://damssupport.bodleian.ox.ac.uk/svn/mlgb3/trunk/solr/ egg=false

# cron jobs
cron = git https://source.bodleian.ox.ac.uk/gitlab/calvin.butcher/mlgb.cron.git path=${buildout:directory}/parts/ egg=false

[docs]
recipe = plone.recipe.bundlecheckout
url=https://damssupport.bodleian.ox.ac.uk/svn/mlgb3/trunk/documentation/

[rename-hardcoded-paths]
recipe = collective.recipe.cmd
on_install = true
cmds = find /home/mlgb/sites/mlgb/ -type f -exec sed -i 's/\/home\/xiaofeng/\/home\/mlgb\/sites\/mlgb\/parts/g' {} \; find /home/mlgb/sites/mlgb/ -type f -exec sed -i 's/\/usr\/share/\/home\/mlgb\/sites\/mlgb/g' {} \;

[cron-script]
recipe = collective.recipe.template
input = conf/cron.txt
output = ${buildout:directory}/parts/jobs/cron.txt

[cron-setup]
recipe = collective.recipe.cmd
on_install = true
cmds = mkdir ${buildout:directory}/parts/BACKUPS; mkdir ${buildout:directory}/parts/index/work; mkdir ${buildout:directory}/static/media/pdf; crontab ${buildout:directory}/parts/jobs/cron.txt; chmod a+x ${buildout:directory}/parts/jobs/wkhtmltopdf.sh;

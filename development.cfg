[buildout]
extensions =
    buildout.bootstrap
    mr.developer

extends =
    buildouts/apache.cfg
    buildouts/solr.cfg
    versions.cfg

parts =
    env
    static
    django
    django-settings
    setup-py
    django-solr-config
    omelette
    solr-download
    solr
    copy-mysql-jars
    solr-config
    books-config
    catalogues-config
    jetty-config
    catalogues-data-config
    books-data-config
    apache
    mod-wsgi-install
    mod-wsgi-config
    apache-wsgi-config
    apache-httpd-config
    cron
    mv-cron-dirs
    docs
    rename-hardcoded-paths1
    rename-hardcoded-paths2
    cron-script
    cron-setup

eggs =
    ${buildout:auto-checkout}
    Django
    MySQL-python
    pillow
    simplejson

auto-checkout =
    mysite
    static
    solr
#    cron

dollar = $

sources-dir = 
    ${buildout:directory}

versions = versions
show-picked-versions = true

serveraddress =  163.1.141.102
servername = mlgb3-dev2.bodleian.ox.ac.uk
serverport = 8080
buildout-user = ${env:USER}

[env]
recipe = gocept.recipe.env

[static]
recipe = z3c.recipe.mkdir
paths = static/

[hosts]
hostname = localhost

[django]
recipe = djangorecipe
settings = settings
eggs = ${buildout:eggs}
project = mysite.apache
extra-paths =
    ${buildout:directory}/mysite/apache
wsgi = true

[django-settings]
recipe = collective.recipe.template
input = conf/settings.py
output = ${buildout:directory}/mysite/apache/settings.py

[setup-py]
recipe = collective.recipe.template
input = conf/setup.py
output = ${buildout:directory}/mysite/setup.py

[django-solr-config]
recipe = collective.recipe.template
input = conf/config.py
output = ${buildout:directory}/mysite/mlgb/config.py

[omelette]
recipe = collective.recipe.omelette
eggs = ${buildout:eggs}

[sources]
mysite = svn https://damssupport.bodleian.ox.ac.uk/svn/mlgb3/trunk/mysite/

# media and templates dir 
static= svn https://damssupport.bodleian.ox.ac.uk/svn/mlgb3/trunk/www/mlgb/ egg=false

# solr conf
solr = svn https://damssupport.bodleian.ox.ac.uk/svn/mlgb3/trunk/solr/ egg=false

[cron]
recipe = git-recipe
repository=https://source.bodleian.ox.ac.uk/gitlab/calvin.butcher/mlgb.cron.git
ref = origin/master
download-directory = ${buildout:directory}/parts/

[mv-cron-dirs]
recipe = collective.recipe.cmd
on_install = true
cmds = mv ${buildout:directory}/parts/mlgb.cron/index/ mv ${buildout:directory}/parts/; mv ${buildout:directory}/parts/mlgb.cron/jobs/ ${buildout:directory}/parts/; rm -rf ${buildout:directory}/parts/mlgb.cron 

[docs]
recipe = plone.recipe.bundlecheckout
url=https://damssupport.bodleian.ox.ac.uk/svn/mlgb3/trunk/documentation/

[rename-hardcoded-paths1]
recipe = collective.recipe.cmd
on_install = true
cmds = find '/home/mlgb/sites/mlgb' -type f -exec sed -i 's/\/home\/xiaofeng\//\/home\/mlgb\/sites\/mlgb\/parts\//g' {} \;

[rename-hardcoded-paths2]
recipe = collective.recipe.cmd
on_install = true
cmds = find '/home/mlgb/sites/mlgb' -type f -exec sed -i 's/\/usr\/share\//\/home\/mlgb\/sites\/mlgb\//g' {} \;

[cron-script]
recipe = collective.recipe.template
input = conf/cron.txt
output = ${buildout:directory}/parts/jobs/cron.txt

[cron-setup]
recipe = collective.recipe.cmd
on_install = true
cmds = mkdir ${buildout:directory}/parts/BACKUPS; mkdir ${buildout:directory}/parts/index/work; mkdir ${buildout:directory}/static/media/pdf; crontab ${buildout:directory}/parts/jobs/cron.txt; chmod a+x ${buildout:directory}/parts/jobs/*.sh;
